app-id: io.github.andrewmkiss.Demeter
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
command: dathena
finish-args:
  - --socket=wayland
  - --socket=x11
  - --share=ipc
  - --filesystem=host

modules:
  - name: hdf4_lib
    disabled: false 
    buildsystem: simple
    no-autogen: true
    build-commands:
      - 'hdf4_lib/install.sh'
    sources:
      - type: archive
        url: https://support.hdfgroup.org/ftp/HDF/releases/HDF4.2.16/src/CMake-hdf-4.2.16.tar.gz
        sha256: e8115564daa913c274f88558c2bc5d6685ef51531c80bf95f6dd92ced1f7b64f
      - commands:
        - set -e
        - cd CMake-hdf-4.2.16/
        - sed -i "79s/set.*/set \( INSTALLDIR \"\/app\")/" HDF4config.cmake
        - ctest -S HDF4config.cmake,BUILD_GENERATOR=Unix -C Release -V -O hdf4.log
        - cd build
        - make install
        dest: hdf4_lib
        dest-filename: install.sh
        type: script

  - name: gnuplot
    disabled: false
    buildsystem: simple
    build-commands:
      - ./configure --prefix=/app/
      - make
      - make install
      - make clean
    sources:
      - type: archive
        url: https://sourceforge.net/projects/gnuplot/files/gnuplot/5.4.8/gnuplot-5.4.8.tar.gz
        sha256: 931279c7caad1aff7d46cb4766f1ff41c26d9be9daf0bcf0c79deeee3d91f5cf

  - name: ncurses
    disabled: false
    buildsystem: autotools
    no-autogen: true
    config-opts: --prefix=/usr
    build-options:
      cflags: '-fPIC'
      cppflags: '-fPIC'
      ldflags: '-fpic'
    sources:
      - type: archive
        url: https://invisible-island.net/datafiles/release/ncurses.tar.gz
        sha256: 97fc51ac2b085d4cde31ef4d2c3122c21abc217e9090a43a30fc5ec21684e059

  - name: ifeffit
    disabled: false
    buildsystem: simple
    build-commands:
      - ./PGPLOT_install --prefix=/app/ --no-png --with-64bit
      - ./configure --prefix=/app/
      - sed -i "s/TERMCAP_LIB =.*/TERMCAP_LIB = -L\/app\/lib -lncurses/" src/cmdline/Makefile
      - make
      - make install
      - sed -i "s/\/run\/build.*/\/app\/lib\/libnopgplot.a/" /app/share/ifeffit/config/Config.mak
      - make clean
    sources:
      - type: file
        url: ftp://astro.caltech.edu/pub/pgplot/pgplot5.2.tar.gz
        sha256: a5799ff719a510d84d26df4ae7409ae61fe66477e3f1e8820422a9a4727a5be4
      - type: archive
        url: https://github.com/newville/ifeffit/archive/refs/tags/1.2.13.tar.gz
        sha256: 46d8ea1b02ea81794c2afee41dd9d3d05fe1178cbd358ef6b9ecf2a77076d909

  ## Using example from:
  ## https://github.com/flatpak/flatpak-builder-tools/blob/master/cpan/README.md
  - name: perl
    disabled: false
    no-autogen: true
    config-opts:
      - '-des'
      # Build a shared library.
      - '-Duseshrplib'
    build-options:
      cflags: '-fPIC'
      ldflags: '-fpic'
    sources:
      - type: archive
        url: https://www.cpan.org/src/5.0/perl-5.36.1.tar.gz
        sha256: 68203665d8ece02988fc77dc92fccbb297a83a4bb4b8d07558442f978da54cc1
      - type: shell
        commands:
          # Have Flatpak run the GNU-compatible configure script.
          - 'ln -s configure{.gnu,}'
    # Restore write permission to the Perl libraries.
    post-install:
      - 'chmod -R u+w /app/lib/perl5'
    # Clean up a bunch of stuff we don't need. Depending on your application,
    # you may have to drop some of these (e.g. *.pod).
    cleanup:
      - '/bin/corelist'
      - '/bin/cpan'
      - '/bin/enc2xs'
      - '/bin/encguess'
      - '/bin/h2ph'
      - '/bin/h2xs'
      - '/bin/instmodsh'
      - '/bin/json_pp'
      - '/bin/libnetcfg'
      - '/bin/perlbug'
      - '/bin/perldoc'
      - '/bin/perlivp'
      - '/bin/perlthanks'
      - '/bin/piconv'
      - '/bin/pl2pm'
      - '/bin/pod*'
      - '/bin/prove'
      - '/bin/ptar*'
      - '/bin/shasum'
      - '/bin/splain'
      - '/bin/xsubpp'
      - '/bin/zipdetails'
      - '/include'
      - '/man'
      - '*.pod'

  ## Using the dependencies from flatpak-cpan-generator
  # Installs the modules generated by flatpak-cpan-generator.
  # Note that *any* Makefile.PL-style modules MUST be installed in this one step,
  # as once perllocal.pod is written in one module, it cannot be modified by others.
  - name: perl-libs
    disabled: false
    buildsystem: simple
    build-commands:
      - 'perl-libs/install.sh'
    # Same as with the Perl module, we need to restore write permission.
    # However, -f is now passed to avoid errors from trying to touch files from the
    # above module that are now marked as read-only.
    post-install:
      - 'chmod -Rf u+w /app/lib/perl5/site_perl'
      - 'chmod u+w /app/bin/pdl*'
    sources:
      - perl-libs.yml
    # This step should be customized based on the CPAN packages you're using.
    cleanup:
      - '/bin'
      - '/man'

  ## Demeter
  - name: demeter
    disabled: false
    buildsystem: simple
    build-options:
      env:
        - PERL5LIB=/run/build/demeter:/app/lib/perl5/site_perl
        - PERLLIB=/app/lib/perl5/site_perl/5.36.1
    build-commands:
      - perl Build.PL
      - sed -i "1653,+3s/25/35/" lib/Demeter/UI/Athena.pm
      - ./Build
      - ./Build install
      - install -Dm 644 -t /app/share/metainfo io.github.andrewmkiss.Demeter.metainfo.xml
      - install -Dm 644 -t /app/share/icons/hicolor/48x48/apps /app/lib/perl5/site_perl/5.36.1/x86_64-linux/Demeter/share/Demeter_icon.png
      - mv /app/share/icons/hicolor/48x48/apps/Demeter_icon.png /app/share/icons/hicolor/48x48/apps/io.github.andrewmkiss.Demeter.png
      - install -Dm 644 -t /app/share/icons/hicolor/48x48/apps /app/lib/perl5/site_perl/5.36.1/x86_64-linux/Demeter/UI/Athena/share/athena_icon.png
      - mv /app/share/icons/hicolor/48x48/apps/athena_icon.png /app/share/icons/hicolor/48x48/apps/io.github.andrewmkiss.Demeter.Athena.png
      - install -Dm 644 -t /app/share/icons/hicolor/48x48/apps /app/lib/perl5/site_perl/5.36.1/x86_64-linux/Demeter/UI/Artemis/share/artemis_icon.png
      - mv /app/share/icons/hicolor/48x48/apps/artemis_icon.png /app/share/icons/hicolor/48x48/apps/io.github.andrewmkiss.Demeter.Artemis.png
      - install -Dm 644 -t /app/share/applications io.github.andrewmkiss.Demeter.Athena.desktop
      - install -Dm 644 -t /app/share/applications io.github.andrewmkiss.Demeter.Artemis.desktop
      - install -Dm 644 -t /app/share/applications io.github.andrewmkiss.Demeter.Hephaestus.desktop
    post-install:
      - 'chmod u+w /app/lib/perl5/site_perl/5.36.1/x86_64-linux/auto/Ifeffit/Ifeffit.so'
    sources:
      - type: git
        url: https://github.com/bruceravel/demeter
        branch: master
        commit: edfaa0904fa30426cf303b5933450edf22a426ec
      - type: file
        path: io.github.andrewmkiss.Demeter.metainfo.xml
      - type: file
        path: io.github.andrewmkiss.Demeter.Athena.desktop
      - type: file
        path: io.github.andrewmkiss.Demeter.Artemis.desktop
      - type: file
        path: io.github.andrewmkiss.Demeter.Hephaestus.desktop
